"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var a={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(a[r]=e[r]);return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_BaiduMapControlBase2=require("./BaiduMapControlBase"),_BaiduMapControlBase3=_interopRequireDefault(_BaiduMapControlBase2),disZoomMap=[[50,18],[100,17],[200,16],[500,15],[1e3,14],[2e3,13],[5e3,12],[1e4,11],[2e4,10],[25e3,9],[5e4,8],[1e5,7],[2e5,6],[5e5,5],[1e6,4],[2e6,3]],random=Math.random(),messageLabelMask={},BaiduMapHeatMapWithPoint=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,_BaiduMapControlBase3.default),_createClass(t,[{key:"showMessage",value:function(e,t,a){function r(e,t,a){this._point=e,this._msg=t,this.map=a}if(e)return r.prototype=new window.BMap.Overlay,r.prototype.initialize=function(){var e=this,t=this._div=document.createElement("div");t.style.position="absolute";var a="map_tooltip_"+Math.random();return t.id=a,t.style.zIndex=window.BMap.Overlay.getZIndex(this._point.lat),setTimeout(function(){var r=_reactDom2.default.render(e._msg(),document.getElementById(a));t.appendChild(r)},0),this.map.getPanes().labelPane.appendChild(t),t},r.prototype.draw=function(){var e=this.map.pointToOverlayPixel(this._point);this._div.style.left=e.x+"px",this._div.style.top=e.y+"px"},function(){var o={position:t,offset:new window.BMap.Size(-50,-50)};"string"==typeof e?messageLabelMask&&(messageLabelMask.label=new window.BMap.Label(e,o),messageLabelMask.label.setStyle({color:"black",borderColor:"#FFFFFF",textAlign:"center",fontSize:"12px",height:"30px",width:"100px",lineHeight:"30px",borderRadius:"15px",fontFamily:"微软雅黑",boxShadow:"5px 5px 5px gray"}),a.addOverlay(messageLabelMask.label)):"function"==typeof e&&messageLabelMask&&(messageLabelMask.label=new r(t,e,a),a.addOverlay(messageLabelMask.label))}}},{key:"removeMessage",value:function(e){return function(){e.removeOverlay(messageLabelMask.label)}}},{key:"mapLoad",value:function(){var e=this,t=this.props,a=t.point,r=t.datas,o=t.points,i=t.radius,n=void 0===i?20:i,p=t.opacity,s=void 0===p?0:p,l=t.gradient,d=void 0===l?{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}:l,u=_objectWithoutProperties(t,["point","datas","points","radius","opacity","gradient"]),f=window.BMap,c=new f.Map("map"+random),y=void 0;if(a)y=new f.Point(a.lng,a.lat),c.centerAndZoom(y,13);else if(1===r.length)y=new f.Point(r[0].lng,r[0].lat),c.centerAndZoom(y,13);else{for(var _=0,h=void 0,m=void 0,b=0;b<r.length-1;b++)for(var v=b;v<r.length;v++){var g=c.getDistance(new f.Point(r[b].lng,r[b].lat),new f.Point(r[v].lng,r[v].lat));g>_&&(h=(r[b].lng+r[v].lng)/2,m=(r[b].lat+r[v].lat)/2,_=g)}y=new f.Point(h,m);var w=disZoomMap.filter(function(e){return e[0]>_});w.length>1&&c.centerAndZoom(y,w[0][1]>16?18:w[0][1]+2)}this.initMapControl(c,u),c.clearOverlays();var T=document.createElement("script");T.async=!0,T.type="text/javascript",T.src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js",document.head.appendChild(T),T.onload=function(){var t=new window.BMapLib.HeatmapOverlay({radius:n,opacity:s,gradient:d});c.addOverlay(t),t.setDataSet({data:r,max:100}),t.show(),Array.isArray(o)&&o.length>0&&o.forEach(function(t){var a=new f.Point(t.location.lng,t.location.lat);if(t.icon)if(t.icon.size){var r=new f.Icon(t.icon.url,new f.Size(t.icon.size.width,t.icon.size.height),t.icon.offsetSize&&{imageOffset:new f.Size(t.icon.offsetSize.width,t.icon.offsetSize.height)});r.imageSize=new f.Size(t.icon.size.width,t.icon.size.height);var o=new f.Marker(a,{icon:r});o.addEventListener("mouseover",e.showMessage(t.name,a,c)),o.addEventListener("mouseout",e.removeMessage(c)),c.addOverlay(o)}else console.log("请输入图片大小！");else{var i=function(e,t,a,r){this.map=r,this._point=e,this._color=t,this._radius=a};(i.prototype=new f.Overlay).initialize=function(){var t=e._div=document.createElement("div");return t.style.position="absolute",t.style.borderRadius="50%",t.style.width=e._radius+"px",t.style.height=e._radius+"px",t.style.background=e._color,t.style.zIndex=f.Overlay.getZIndex(e._point.lat),e.map.getPanes().labelPane.appendChild(t),t},i.prototype.draw=function(){var t=e.map.pointToOverlayPixel(e._point);e._div.style.left=t.x-e._radius/2+"px",e._div.style.top=t.y-e._radius/2+"px"};var n=new i(a,t.color||"red",t.radius||12,c);c.addOverlay(n),n._div.addEventListener("mouseover",e.showMessage(t.name,a,c)),n._div.addEventListener("mouseout",e.removeMessage(c))}})}}},{key:"render",value:function(){var e=this.props.style,t=void 0===e?{}:e;return window["mapload"+random.toString().substr(2)]=this.mapLoad.bind(this),void 0===window.BMap?function(){var e=document.createElement("script");e.src="http://api.map.baidu.com/api?v=2.0&ak=C4f54f1b740bc62107184968edbb64fb&callback=mapload"+random.toString().substr(2),document.body.appendChild(e)}():setTimeout(this.mapLoad.bind(this),0),_react2.default.createElement("div",{id:"map"+random,style:_extends({height:"100%",width:"100%"},t)})}}]),t}();BaiduMapHeatMapWithPoint.propTypes={style:_propTypes2.default.object,point:_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired}),datas:_propTypes2.default.arrayOf(_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired,count:_propTypes2.default.number.isRequired})).isRequired,opacity:_propTypes2.default.number,radius:_propTypes2.default.number,gradient:_propTypes2.default.object,points:_propTypes2.default.arrayOf(_propTypes2.default.shape({name:_propTypes2.default.oneOfType([_propTypes2.default.func,_propTypes2.default.string]),location:_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired}).isRequired,icon:_propTypes2.default.shape({url:_propTypes2.default.string.isRequired,size:_propTypes2.default.shape({width:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string]),height:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string])}),offsetSize:_propTypes2.default.shape({width:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string]),height:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string])})}),radius:_propTypes2.default.number}))},exports.default=BaiduMapHeatMapWithPoint;