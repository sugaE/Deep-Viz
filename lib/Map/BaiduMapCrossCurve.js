"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_echarts=require("echarts"),_echarts2=_interopRequireDefault(_echarts);require("echarts/extension/bmap/bmap");var _BaiduMapControlBase2=require("./BaiduMapControlBase"),_BaiduMapControlBase3=_interopRequireDefault(_BaiduMapControlBase2),disZoomMap=[[50,18],[100,17],[200,16],[500,15],[1e3,14],[2e3,13],[5e3,12],[1e4,11],[2e4,10],[25e3,9],[5e4,8],[1e5,7],[2e5,6],[5e5,5],[1e6,4],[2e6,3]],random=Math.random(),BaiduMapCrossCurve=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.color=e.colors||["#FDB933","#D64F44","#00A6AC","#1D953F","#E0861A","#45B97C","#F3715C","#F26522","#7FB80E","#63C5FA"],r.symbol=["circle","rect","roundRect","triangle","diamond","pin","arrow","path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z"],r.EMap=null,r.myChart=null,r.customOverlays=[],r}return _inherits(t,_BaiduMapControlBase3.default),_createClass(t,[{key:"componentDidMount",value:function(){window["mapload"+random.toString().substr(2)]=this.mapload.bind(this),"undefined"==typeof BMap?this.loadScript():this.mapload()}},{key:"componentWillReceiveProps",value:function(e){this.mapload(e)}},{key:"loadScript",value:function(){var e=document.createElement("script");e.src="http://api.map.baidu.com/api?v=2.0&ak=C4f54f1b740bc62107184968edbb64fb&callback=mapload"+random.toString().substr(2),document.body.appendChild(e)}},{key:"mapload",value:function(e){var t=this,r=this.props;if(e){if(e.point===this.props.point&&e.datas===this.props.datas&&e.direction===this.props.direction)return;r=e}var a=r,o=a.direction,n=a.datas,i=a.point,l=a.tooltipFormat,s=a.labelFormat,p=a.radiusColor,u=void 0===p?"#4990E2":p;this.EMap&&this.customOverlays.length>0&&(this.customOverlays.forEach(function(e){t.EMap.removeOverlay(e)}),this.customOverlays=[]);var c=this.symbol[6],d=this.color;this.myChart||(this.myChart=_echarts2.default.init(document.getElementById("map"+random)));var f=[];f.push(i.lng,i.lat,100);var m={name:i.name,type:"effectScatter",coordinateSystem:"bmap",zlevel:2,tooltip:{position:"right",formatter:"{b}"},rippleEffect:{brushType:"stroke",scale:3},symbolSize:15,showEffectOn:"render",data:[{name:i.name,value:f}]},h=0;n.forEach(function(e){h+=e.value||0});var y={name:i.name,type:"effectScatter",coordinateSystem:"bmap",zlevel:2,rippleEffect:{brushType:"stroke",scale:3},tooltip:{position:"right",formatter:l||null},label:{normal:{show:!0,position:"right",formatter:s||null}},symbolSize:function(e){return e[2]&&h>0?parseInt(e[2]/h*100,10)/4:10},showEffectOn:"render",itemStyle:{normal:{}},data:n.map(function(e,t){var r=[];return r.push(e.lng,e.lat,e.value||null),{name:e.name,value:r,itemStyle:{normal:{color:e.color||d[t]}}}})},v=[];v.push(i.lng,i.lat);var b={type:"lines",coordinateSystem:"bmap",zlevel:2,effect:{show:!0,period:2,trailLength:0,symbol:c,symbolSize:8},lineStyle:{normal:{width:3,opacity:.7,curveness:.2}},data:n.map(function(e,t){var r=[];return r.push(e.lng,e.lat),{fromName:"in"===o?e.name:i.name,toName:"in"===o?i.name:e.name,name:e.name,coords:"in"===o?[r,v]:[v,r],lineStyle:{normal:{color:e.color||d[t]}}}})},_=[];_.push(m,y,b);var g={bmap:{roam:!1},tooltip:{trigger:"item"},series:_,color:["#108EE9"]};this.myChart.setOption(g),this.EMap=this.myChart.getModel().getComponent("bmap").getBMap();var C=window.BMap,E=new C.NavigationControl;this.EMap.enableDragging(),this.EMap.addControl(E);var M=new C.Point(i.lng,i.lat);(this.props.radiusGradients||[]).forEach(function(e){var r=new C.Circle(M,e,{fillColor:u,fillOpacity:.3,strokeOpacity:.3,strokeColor:u,strokeWeight:1});t.EMap.addOverlay(r),t.customOverlays.push(r);var a=r.getBounds().getNorthEast(),o=new C.Label(e/1e3+"km",{position:new C.Point(M.lng,a.lat),offset:new C.Size(0,0)});o.setStyle({color:"#fff",fontSize:"8px",border:"none",backgroundColor:"transparent"}),t.EMap.addOverlay(o),t.customOverlays.push(o)});var w=0;this.props.datas.forEach(function(e){var r=t.EMap.getDistance(new C.Point(e.lng,e.lat),new C.Point(i.lng,i.lat));w=r>w?r:w});var O=disZoomMap.filter(function(e){return e[0]>w});this.EMap.centerAndZoom(new C.Point(i.lng,i.lat),O[0][1]>16?18:O[0][1]+2),this.initMapControl(this.EMap,r)}},{key:"render",value:function(){var e=this.props.style,t=void 0===e?{}:e;return _react2.default.createElement("div",{id:"map"+random,style:_extends({height:"100%",width:"100%"},t)})}}]),t}();BaiduMapCrossCurve.propTypes={style:_propTypes2.default.object,point:_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired,name:_propTypes2.default.string}).isRequired,radiusGradients:_propTypes2.default.arrayOf(_propTypes2.default.number),radiusColor:_propTypes2.default.string,datas:_propTypes2.default.arrayOf(_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired,name:_propTypes2.default.string,value:_propTypes2.default.number,color:_propTypes2.default.string})).isRequired,direction:_propTypes2.default.string.isRequired,tooltipFormat:_propTypes2.default.func,labelFormat:_propTypes2.default.func},exports.default=BaiduMapCrossCurve;