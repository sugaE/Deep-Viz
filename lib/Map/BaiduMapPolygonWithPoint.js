"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var o={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(o[r]=e[r]);return o}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_BaiduMapControlBase2=require("./BaiduMapControlBase"),_BaiduMapControlBase3=_interopRequireDefault(_BaiduMapControlBase2),random=Math.random(),messageLabelMask={},BaiduMapPolygonWithPoint=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,_BaiduMapControlBase3.default),_createClass(t,[{key:"showMessage",value:function(e,t,o){function r(e,t,o){this._point=e,this._msg=t,this.map=o}if(e)return r.prototype=new window.BMap.Overlay,r.prototype.initialize=function(){var e=this;console.log("initialize");var t=this._div=document.createElement("div");t.style.position="absolute";var o="map_tooltip_"+Math.random();return t.id=o,t.style.zIndex=window.BMap.Overlay.getZIndex(this._point.lat),setTimeout(function(){var r=_reactDom2.default.render(e._msg(),document.getElementById(o));t.appendChild(r)},0),this.map.getPanes().labelPane.appendChild(t),t},r.prototype.draw=function(){var e=this.map.pointToOverlayPixel(this._point);this._div.style.left=e.x+"px",this._div.style.top=e.y+"px"},function(){var a={position:t,offset:new window.BMap.Size(-50,-50)};"string"==typeof e?messageLabelMask&&(messageLabelMask.label=new window.BMap.Label(e,a),messageLabelMask.label.setStyle({color:"black",borderColor:"#FFFFFF",textAlign:"center",fontSize:"12px",height:"30px",width:"100px",lineHeight:"30px",borderRadius:"15px",fontFamily:"微软雅黑",boxShadow:"5px 5px 5px gray"}),o.addOverlay(messageLabelMask.label)):"function"==typeof e&&messageLabelMask&&(messageLabelMask.label=new r(t,e,o),o.addOverlay(messageLabelMask.label))}}},{key:"removeMessage",value:function(e){return function(){e.removeOverlay(messageLabelMask.label)}}},{key:"mapLoad",value:function(){var e=this,t=this.props,o=t.point,r=t.circleColor,a=void 0===r?"#108EE9":r,i=t.labelColor,n=void 0===i?"#FFFFFF":i,l=t.datas,s=t.points,p=t.outsideLabel,d=t.zoomBias,u=void 0===d?1:d,f=_objectWithoutProperties(t,["point","circleColor","labelColor","datas","points","outsideLabel","zoomBias"]),y=window.BMap,c=new y.Map("map"+random),_=new y.Point(o.lng,o.lat);this.initMapControl(c,f),c.clearOverlays();var h={fillColor:a,strokeColor:a,strokeWeight:1,strokeOpacity:.3,fillOpacity:.3},b=new y.Circle(_,80,{fillColor:a,strokeColor:a,strokeWeight:1,strokeOpacity:.8,fillOpacity:.8});c.addOverlay(b),l.sort(function(e,t){return e.radius-t.radius>0});for(var v=l[l.length-1].radius,m=[.05,.1,.2,.5,1,2,5,10,20,25,50,100,200,500,1e3,2e3],g=0;g<m.length&&!(m[g]>=v);g++);g=g-1<0?0:g-1,c.centerAndZoom(_,18-g),c.setMinZoom(18-u-g<3?3:18-u-g),c.setMaxZoom(18+u-g>18?18:18+u-g);var w=l.map(function(e){var t=new y.Circle(_,1e3*e.radius,h);return c.addOverlay(t),t});if(l.map(function(e,t){var r=void 0,a=void 0,i=void 0;if(0===t)r=_,a=new y.Point(o.lng+.01,o.lat-.01),i=new y.Point(o.lng+.06,o.lat-.01);else{var l=w[t].getBounds().getNorthEast(),s=w[t-1].getBounds().getNorthEast();r=new y.Point((l.lng-s.lng)*Math.sqrt(2)/4+(s.lng-_.lng)*Math.sqrt(2)/2+_.lng,(l.lat-s.lat)*Math.sqrt(2)/4+(s.lat-_.lat)*Math.sqrt(2)/2+_.lat),a=new y.Point(r.lng+.005,r.lat+.005),i=new y.Point(r.lng+.06,r.lat+.005)}var p=new y.Polyline([r,a,i],{strokeColor:n,strokeWeight:1});if(c.addOverlay(p),e.label){var d=new y.Circle(r,50,{fillColor:n,strokeColor:n,strokeWeight:1,strokeOpacity:1,fillOpacity:1}),u=void 0;if("string"==typeof e.label)u=""+e.label;else if("object"===_typeof(e.label)){var f=document.createElement("div");_reactDom2.default.render(e.label,f),u=""+f.innerHTML}var h=new y.Label('<div style="position: absolute; bottom: 0">'+u+"</div>",{position:a,offset:new y.Size(5,0)});h.setStyle({border:"0",backgroundColor:null,color:n}),c.addOverlay(d),c.addOverlay(h)}return""}),p){var T=w[w.length-1].getBounds().getNorthEast(),O=new y.Point(T.lng,2*o.lat-T.lat),M=new y.Point((O.lng-o.lng)*Math.sqrt(2)/4+o.lng/2+O.lng/2,(O.lat-o.lat)*Math.sqrt(2)/4+o.lat/2+O.lat/2),C=M,k=new y.Point(M.lng+.05,M.lat),P=new y.Polyline([M,C,k],{strokeColor:n,strokeWeight:1});c.addOverlay(P);var x=new y.Circle(M,50,{fillColor:n,strokeColor:n,strokeWeight:1,strokeOpacity:1,fillOpacity:1}),z=void 0;if("string"==typeof p)z=""+p;else if("object"===(void 0===p?"undefined":_typeof(p))){var B=document.createElement("div");_reactDom2.default.render(p,B),z=""+B.innerHTML}var L=new y.Label('<div style="position: absolute; bottom: 0">'+z+"</div>",{position:C,offset:new y.Size(5,0)});L.setStyle({border:"0",backgroundColor:null,color:n}),c.addOverlay(x),c.addOverlay(L)}Array.isArray(s)&&s.length>0&&s.forEach(function(t){var o=new y.Point(t.location.lng,t.location.lat);if(t.icon)if(t.icon.size){var r=new y.Icon(t.icon.url,new y.Size(t.icon.size.width,t.icon.size.height),t.icon.offsetSize&&{imageOffset:new y.Size(t.icon.offsetSize.width,t.icon.offsetSize.height)});r.imageSize=new y.Size(t.icon.size.width,t.icon.size.height);var a=new y.Marker(o,{icon:r});a.addEventListener("mouseover",e.showMessage(t.name,o,c)),a.addEventListener("mouseout",e.removeMessage(c)),c.addOverlay(a)}else console.log("请输入图片大小！");else{var i=function(e,t,o,r){this.map=r,this._point=e,this._color=t,this._radius=o};(i.prototype=new y.Overlay).initialize=function(){var t=e._div=document.createElement("div");return t.style.position="absolute",t.style.borderRadius="50%",t.style.width=e._radius+"px",t.style.height=e._radius+"px",t.style.background=e._color,t.style.zIndex=y.Overlay.getZIndex(e._point.lat),e.map.getPanes().labelPane.appendChild(t),t},i.prototype.draw=function(){var t=e.map.pointToOverlayPixel(e._point);e._div.style.left=t.x-e._radius/2+"px",e._div.style.top=t.y-e._radius/2+"px"};var n=new i(o,t.color||"red",t.radius||12,c);c.addOverlay(n),n._div.addEventListener("mouseover",e.showMessage(t.name,o,c)),n._div.addEventListener("mouseout",e.removeMessage(c))}})}},{key:"render",value:function(){var e=this.props.style,t=void 0===e?{}:e;return window["mapload"+random.toString().substr(2)]=this.mapLoad.bind(this),void 0===window.BMap?function(){var e=document.createElement("script");e.src="http://api.map.baidu.com/api?v=2.0&ak=C4f54f1b740bc62107184968edbb64fb&callback=mapload"+random.toString().substr(2),document.body.appendChild(e)}():setTimeout(this.mapLoad.bind(this),0),_react2.default.createElement("div",{id:"map"+random,style:_extends({height:"100%",width:"100%"},t)})}}]),t}();BaiduMapPolygonWithPoint.propTypes={style:_propTypes2.default.object,point:_propTypes2.default.object.isRequired,disableDragging:_propTypes2.default.bool,circleColor:_propTypes2.default.string,labelColor:_propTypes2.default.string,datas:_propTypes2.default.arrayOf(_propTypes2.default.shape({radius:_propTypes2.default.number.isRequired,label:_propTypes2.default.oneOfType([_propTypes2.default.element,_propTypes2.default.string]).isRequired})).isRequired,outsideLabel:_propTypes2.default.oneOfType([_propTypes2.default.element,_propTypes2.default.string]),zoomBias:_propTypes2.default.number,points:_propTypes2.default.arrayOf(_propTypes2.default.shape({name:_propTypes2.default.oneOfType([_propTypes2.default.func,_propTypes2.default.string]),location:_propTypes2.default.shape({lat:_propTypes2.default.number.isRequired,lng:_propTypes2.default.number.isRequired}).isRequired,icon:_propTypes2.default.shape({url:_propTypes2.default.string.isRequired,size:_propTypes2.default.shape({width:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string]),height:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string])}),offsetSize:_propTypes2.default.shape({width:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string]),height:_propTypes2.default.oneOfType([_propTypes2.default.number,_propTypes2.default.string])})}),radius:_propTypes2.default.number}))},exports.default=BaiduMapPolygonWithPoint;