"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i}function _inherits(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(i,e,a){return e&&t(i.prototype,e),a&&t(i,a),i}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),ScatterCurveMap=function(t){function i(t){_classCallCheck(this,i);var e=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t));return e.mapLoad=function(){(new BMap.Boundary).get(e.props.mapConfig.map.name||"徐汇区",function(t){var i=[];t.boundaries.length>0&&(i=t.boundaries[0].split(";"));var a=i.map(function(t){var i=t.split(",");return e.lonlatTomercator([Number(i[0]),Number(i[1])])});e.chinaPoints=a,e.renderMap(),e.renderCircle(),e.offContext.drawImage(e.canvas,0,0)})},e.loadScript=function(){var t=document.createElement("script");t.src="http://api.map.baidu.com/api?v=2.0&ak=C4f54f1b740bc62107184968edbb64fb&callback=mapLoad",document.body.appendChild(t)},e.renderMap=function(){if(Array.isArray(e.chinaPoints)&&e.chinaPoints.length>0){e.maxScreenDis=Math.min(e.canvas.width,e.canvas.height),e.minLng=e.chinaPoints[0][0],e.maxLat=e.chinaPoints[0][1],e.maxLng=e.chinaPoints[0][0],e.minLat=e.chinaPoints[0][1],e.chinaPoints.forEach(function(t){e.minLng=Math.min(e.minLng,t[0]),e.maxLat=Math.max(e.maxLat,t[1]),e.maxLng=Math.max(e.maxLng,t[0]),e.minLat=Math.min(e.maxLat,t[1])}),e.centerPoint=[(e.minLng+e.maxLng)/2,(e.maxLat+e.minLat)/2],e.currentSource=e.centerPoint,e.ratio=1.3*Math.min(e.canvas.width,e.canvas.height)/e.distancePoint([e.minLng,e.maxLat],[e.maxLng,e.minLat]),e.chinaPoints.forEach(function(t){e.maxLength=Math.max(e.maxLength,e.distancePoint([e.minLng,e.maxLat],t))}),e.ratio=e.maxScreenDis/e.maxLength;var t=[];e.chinaPoints.forEach(function(i){var a=-(i[1]-e.centerPoint[1])*e.ratio,n=(i[0]-e.centerPoint[0])*e.ratio;t.push([n,a])}),e.context.fillStyle=e.props.mapConfig.map.mapBackgroundColor||"#020B22",e.context.fillRect(0,0,e.canvas.width,e.canvas.height),e.context.translate(e.canvas.width/2+.5,e.canvas.height/2+.5),e.context.beginPath(),t.forEach(function(t,i){0===i?e.context.moveTo(t[0],t[1]):e.context.lineTo(t[0],t[1])}),e.context.closePath(),e.context.fillStyle="rgba(3,23,60,0.8)",e.context.strokeStyle="#2268A0",e.props.mapConfig&&e.props.mapConfig.map&&e.props.mapConfig.map.areaBackgroundColor&&(e.context.fillStyle=e.props.mapConfig.map.areaBackgroundColor),e.props.mapConfig&&e.props.mapConfig.map&&e.props.mapConfig.map.areaLineColor&&(e.context.strokeStyle=e.props.mapConfig.map.areaLineColor),e.context.stroke(),e.context.fill()}},e.renderCircle=function(){if(e.props.mapConfig&&e.props.mapConfig.toPoints&&e.props.mapConfig.fromPoint&&Array.isArray(e.props.mapConfig.fromPoint)&&Array.isArray(e.props.mapConfig.toPoints)){var t=!1,i=!0;e.props.mapConfig&&e.props.mapConfig.travelDirection&&"to-from"===e.props.mapConfig.travelDirection&&(i=!1),e.props.mapConfig&&e.props.mapConfig.travelType&&"circle"===e.props.mapConfig.travelType&&(t=!0);var a=[(e.lonlatTomercator(e.props.mapConfig.fromPoint)[0]-e.currentSource[0])*e.ratio,(e.currentSource[1]-e.lonlatTomercator(e.props.mapConfig.fromPoint)[1])*e.ratio];e.props.mapConfig.toPoints.forEach(function(n){var o=e.lonlatTomercator(n),s=[(o[0]-e.currentSource[0])*e.ratio,(e.currentSource[1]-o[1])*e.ratio],r=e.color[Math.floor(13*Math.random())];new e.CirclePoint(s[0],s[1],8,r,e.context,e.offCanvas,e.props.mapConfig.map.type).start(),e.circles.push(s);var h=new e.LineStroke(i?a:s,i?s:a,e.context,r,1,e.offCanvas,e.CirclePoint,t,e.props.mapConfig.map.type);h.start(),e.lines.push(h)}),e.circle=new e.CirclePoint(a[0],a[1],8,e.color[Math.floor(13*Math.random())],e.context,e.offCanvas,e.props.mapConfig.map.type),e.circle.start()}},e.lonlatTomercator=function(t){var i=t,e=[],a=20037508.34*i[0]/180;Math.abs(i[1])>85.05112877980659&&(i[1]=85.05112877980659*Math.abs(i[1])/i[1]);var n=Math.log(Math.tan((90+i[1])*Math.PI/360))/(Math.PI/180);return n=20037508.34*n/180,e[0]=a,e[1]=n,e},e.distancePoint=function(t,i){var e=t[0]-i[0],a=t[1]-i[1];return Math.sqrt(e*e+a*a)},e.id=Math.random()+"-canvas",e.canvas=null,e.context=null,e.offCanvas=document.createElement("canvas"),e.offContext=e.offCanvas.getContext("2d"),e.maxScreenDis=0,e.sourceTomer=e.lonlatTomercator([-180,85.05112877980659]),e.maxGeoDis=e.distancePoint(e.sourceTomer,e.lonlatTomercator([180,-85.05112877980659])),e.ratio=0,e.areaArray=[],e.chinaPoints=[],e.screenPoints=[],e.Rect=null,e.lastArea=null,e.lastLine=null,e.scaleRatio=3,e.minLng=0,e.maxLat=0,e.maxLength=0,e.circles=[],e.circle=null,e.lines=[],e.maxLng=null,e.minLng=null,e.maxLat=null,e.minLat=null,e.centerPoint=null,e.color=["#FDB933","#D64F44","#00A6AC","#1D953F","#E0861A","#45B97C","#F3715C","#F26522","#7FB80E","#63C5FA","#DDF8FF","#FFF3DD","#D45156"],e.CirclePoint=function(t,i,e,a,n,o,s){this.x=t,this.y=i,this.radius=e,this.color=a,this.context=n,this.offCanvas=o,this.tempRadius=this.radius,this.mapType=s,this.centerCirclePath=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.centerCirclePath.setAttribute("cx",this.x),this.centerCirclePath.setAttribute("cy",this.y),this.centerCirclePath.setAttribute("r",this.radius),this.centerCirclePath.setAttribute("fill",this.color)},e.CirclePoint.prototype.createAreaPath=function(){this.context.beginPath(),this.context.rect(this.x-2*this.radius-this.context.lineWidth,this.y-2*this.radius-this.context.lineWidth,4*this.radius+this.context.lineWidth,4*this.radius+this.context.lineWidth)},e.CirclePoint.prototype.createCenterCirclePath=function(){this.context.beginPath(),this.context.arc(this.x,this.y,this.radius,0,2*Math.PI)},e.CirclePoint.prototype.createCenterCircleClipPath=function(){this.context.beginPath(),this.context.arc(this.x,this.y,this.radius+2,0,2*Math.PI)},e.CirclePoint.prototype.strokePath=function(){this.context.save(),this.context.strokeStyle=this.color,this.context.stroke(),this.context.restore()},e.CirclePoint.prototype.strokeCirclePath=function(){this.context.save(),this.context.strokeStyle=this.color,this.context.stroke(),this.context.restore(),this.context.restore()},e.CirclePoint.prototype.fillPath=function(){this.context.save(),this.context.fillStyle=this.color,this.context.fill(),this.context.restore()},e.CirclePoint.prototype.createFlashCirclePath=function(t){this.context.beginPath(),this.context.save(),this.context.globalAlpha=(3*this.radius-t)/(2*this.radius),this.context.arc(this.x,this.y,t,0,2*Math.PI)},e.CirclePoint.prototype.drawAnimate=function(){this.context.beginPath(),this.context.clearRect(this.x-8/3*this.radius-this.context.lineWidth,this.y-8/3*this.radius-this.context.lineWidth,16*this.radius/3+2*this.context.lineWidth,16*this.radius/3+2*this.context.lineWidth),this.context.drawImage(this.offCanvas,"province"!==this.mapType&&"district"!==this.mapType?this.x-8/3*this.radius-this.context.lineWidth:this.x-8/3*this.radius-this.context.lineWidth+this.offCanvas.width/2+.5,"province"!==this.mapType&&"district"!==this.mapType?this.y-8/3*this.radius-this.context.lineWidth:this.y-8/3*this.radius-this.context.lineWidth+this.offCanvas.height/2+.5,16*this.radius/3+2*this.context.lineWidth,16*this.radius/3+2*this.context.lineWidth,this.x-8/3*this.radius-this.context.lineWidth,this.y-8/3*this.radius-this.context.lineWidth,16*this.radius/3+2*this.context.lineWidth,16*this.radius/3+2*this.context.lineWidth),this.createCenterCirclePath(),this.fillPath(),this.createFlashCirclePath(this.tempRadius+this.radius/3),this.strokeCirclePath(),this.createFlashCirclePath(this.tempRadius+2*this.radius/3),this.strokeCirclePath(),this.createFlashCirclePath(this.tempRadius),this.strokeCirclePath()},e.CirclePoint.prototype.animate=function(){this.tempRadius>=2*this.radius?this.tempRadius=this.radius:(this.tempRadius+=.2,this.drawAnimate()),window.requestAnimationFrame(this.animate.bind(this))},e.CirclePoint.prototype.start=function(){window.requestAnimationFrame(this.animate.bind(this))},e.LineStroke=function(t,i,e,a,n,o,s,r,h){this.from=t,this.to=i,this.context=e,this.color=a,this.width=n,this.offCanvas=o,this.mapType=h,this.path=window.document.createElementNS("http://www.w3.org/2000/svg","path"),this.pathLength=0,this.interLength=0,this.step=0,this.CirclePoint=s,this.circle=new this.CirclePoint(this.from[0],this.from[1],r?8:4,r?this.color:"rgba(255,255,255,0.8)",e,o),this.secondcircle=null},e.LineStroke.prototype.getControlPoint=function(){var t=this.to[1]>this.from[1]?this.to:this.from,i=this.to[1]>this.from[1]?this.from:this.to,e=t[1]-i[1],a=t[0]-i[0],n=(t[0]+i[0])/2,o=(t[1]+i[1])/2,s=Math.sqrt(e*e+a*a),r=Math.atan2(e,a);return[n-Math.sin(r)*s/5,o-Math.cos(r)*s/5]},e.LineStroke.prototype.createCurvePath=function(){this.context.beginPath(),this.context.moveTo(this.from[0],this.from[1]);var t=this.getControlPoint();this.context.quadraticCurveTo(t[0],t[1],this.to[0],this.to[1])},e.LineStroke.prototype.strokeCurve=function(){this.context.save(),this.context.strokeStyle=this.color,t.mapConfig&&"circle"===t.mapConfig.travelType&&(this.context.strokeStyle="transparent"),this.context.lineWidth=this.width,this.context.stroke(),this.context.restore()},e.LineStroke.prototype.createPath=function(){var t=this.getControlPoint();this.path.setAttributeNS(null,"d","M"+this.from[0]+" "+this.from[1]+" Q"+t[0]+" "+t[1]+" "+this.to[0]+" "+this.to[1]),this.pathLength=this.path.getTotalLength(),this.interLength=this.pathLength/100},e.LineStroke.prototype.start=function(){this.createCurvePath(),this.strokeCurve(),this.createPath(),window.requestAnimationFrame(this.animate.bind(this))},e.LineStroke.prototype.animate=function(){this.step>=this.pathLength&&(this.step=0),this.step+=this.interLength;var i=parseInt(this.path.getPointAtLength(this.step).x,10),e=parseInt(this.path.getPointAtLength(this.step).y,10);t.mapConfig&&"circle"!==t.mapConfig.travelType&&(this.secondcircle||(this.secondcircle=new this.CirclePoint(this.circle.x,this.circle.y,3,"rgba(255,255,255,0.6)",this.context,this.offCanvas)),this.step!==this.interLength||this.thirdcircle||(this.thirdcircle=new this.CirclePoint(this.circle.x,this.circle.y,2,"rgba(255,255,255,0.4)",this.context,this.offCanvas)),this.step!==2*this.interLength||this.fourthcircle||(this.fourthcircle=new this.CirclePoint(this.circle.x,this.circle.y,1,"rgba(255,255,255,0.2)",this.context,this.offCanvas))),this.fourthcircle&&(this.context.save(),this.fourthcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.fourthcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.thirdcircle&&(this.context.save(),this.thirdcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.thirdcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.secondcircle&&(this.context.save(),this.secondcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.secondcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.context.save(),this.circle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.circle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore(),this.createCurvePath(),this.strokeCurve(),this.fourthcircle&&(this.fourthcircle.x=this.thirdcircle.x,this.fourthcircle.y=this.thirdcircle.y,this.fourthcircle.createCenterCirclePath(),this.fourthcircle.fillPath()),this.thirdcircle&&(this.thirdcircle.x=this.secondcircle.x,this.thirdcircle.y=this.secondcircle.y,this.thirdcircle.createCenterCirclePath(),this.thirdcircle.fillPath()),this.secondcircle&&(this.secondcircle.x=this.circle.x,this.secondcircle.y=this.circle.y,this.secondcircle.createCenterCirclePath(),this.secondcircle.fillPath()),this.circle.x=i,this.circle.y=e,this.circle.createCenterCirclePath(),this.circle.fillPath(),window.requestAnimationFrame(this.animate.bind(this))},e.Point=function(t,i){this.x=t,this.y=i},e.Area=function(t,i){this.points=t,this.context=i},e.Area.prototype.createMapPath=function(){var t=this;"length"in this.points&&(this.context.beginPath(),this.points.forEach(function(i,e){0===e?t.context.moveTo(i.x,i.y):t.context.lineTo(i.x,i.y)}),this.context.closePath())},e.Area.prototype.drawMap=function(){this.createMapPath(),this.context.save(),this.context.translate(.5,.5),this.context.fillStyle="rgba(3,23,60,0.8)",this.context.strokeStyle="#2268A0",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.areaBackgroundColor),t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaLineColor&&(this.context.strokeStyle=t.mapConfig.map.areaLineColor),this.context.fill(),this.context.stroke(),this.context.restore()},e.Area.prototype.cleardrawMap=function(){this.createMapPath(),this.context.save(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.fillStyle="#020B22",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.mapBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.mapBackgroundColor),this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.context.translate(.5,.5),this.context.fillStyle="rgba(3,23,60,0.8)",this.context.strokeStyle="#2268A0",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.areaBackgroundColor),t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaLineColor&&(this.context.strokeStyle=t.mapConfig.map.areaLineColor),this.context.fill(),this.context.stroke(),this.context.restore()},e.Area.prototype.drawPath=function(){this.context.fill(),this.context.stroke()},e}return _inherits(i,_react2.default.Component),_createClass(i,[{key:"componentDidMount",value:function(){var t=this;this.canvas=document.getElementById(this.id),this.context=this.canvas.getContext("2d");var i=window.getComputedStyle(this.canvas.parentNode),e=Math.floor(window.parseInt(i.width)),a=Math.floor(window.parseInt(i.height));if(this.canvas.style.width=e+"px",this.canvas.style.height=a+"px",this.canvas.width=e*this.scaleRatio,this.canvas.height=a*this.scaleRatio,this.offCanvas.width=e*this.scaleRatio,this.offCanvas.height=a*this.scaleRatio,this.maxScreenDis=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height),this.props.mapConfig&&this.props.mapConfig.map&&"world"===this.props.mapConfig.map.type){this.currentSource=this.sourceTomer,this.ratio=this.maxScreenDis/this.maxGeoDis;require("../assets/map/WorldMap.json").features.forEach(function(i){if("Polygon"===i.geometry.type){var e=[];i.geometry.coordinates[0].forEach(function(i){var a=t.lonlatTomercator(i),n=(a[0]-t.sourceTomer[0])*t.ratio,o=Math.abs(a[1]-t.sourceTomer[1])*t.ratio,s=new t.Point(n,o);e.push(s)});var a=new t.Area(e,t.context);t.areaArray.push(a)}else"MultiPolygon"===i.geometry.type&&i.geometry.coordinates.forEach(function(i){var e=[];i[0].forEach(function(i){var a=t.lonlatTomercator(i),n=(a[0]-t.sourceTomer[0])*t.ratio,o=-(a[1]-t.sourceTomer[1])*t.ratio,s=new t.Point(n,o);e.push(s)});var a=new t.Area(e,t.context);t.areaArray.push(a)})}),this.context.fillStyle=this.props.mapConfig.map.mapBackgroundColor||"#020B22",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.translate(.5,.5),this.areaArray.forEach(function(t){t.drawMap()}),this.offContext.drawImage(this.canvas,0,0),this.renderCircle()}if(this.props.mapConfig&&this.props.mapConfig.map&&"province"===this.props.mapConfig.map.type&&this.props.mapConfig.map.name){require("../assets/map/"+this.props.mapConfig.map.name+".json").features.forEach(function(i){if("Polygon"===i.geometry.type){var e=[];i.geometry.coordinates[0].forEach(function(i){var a=t.lonlatTomercator(i),n=a[0],o=a[1];null===t.maxLng?t.maxLng=n:t.maxLng=Math.max(t.maxLng,n),null===t.minLng?t.minLng=n:t.minLng=Math.min(t.minLng,n),null===t.maxLat?t.maxLat=o:t.maxLat=Math.max(t.maxLat,o),null===t.minLat?t.minLat=o:t.minLat=Math.min(t.minLat,o);var s=new t.Point(n,o);e.push(s)});var a=new t.Area(e,t.context);t.areaArray.push(a)}else"MultiPolygon"===i.geometry.type&&i.geometry.coordinates.forEach(function(i){var e=[];i[0].forEach(function(i){var a=t.lonlatTomercator(i),n=a[0],o=a[1];null===t.maxLng?t.maxLng=n:t.maxLng=Math.max(t.maxLng,n),null===t.minLng?t.minLng=n:t.minLng=Math.min(t.minLng,n),null===t.maxLat?t.maxLat=o:t.maxLat=Math.max(t.maxLat,o),null===t.minLat?t.minLat=o:t.minLat=Math.min(t.minLat,o);var s=new t.Point(n,o);e.push(s)});var a=new t.Area(e,t.context);t.areaArray.push(a)})}),this.centerPoint=[(this.minLng+this.maxLng)/2,(this.maxLat+this.minLat)/2],this.currentSource=this.centerPoint,this.ratio=1.3*Math.min(this.canvas.width,this.canvas.height)/this.distancePoint([this.minLng,this.maxLat],[this.maxLng,this.minLat]);for(var n=this.areaArray.length-1;n>=0;n--)for(var o=this.areaArray[n].points,s=o.length-1;s>=0;s--){var r=o[s],h=(r.x-this.centerPoint[0])*this.ratio,c=-(r.y-this.centerPoint[1])*this.ratio;r.x=h,r.y=c}this.context.fillStyle=this.props.mapConfig.map.mapBackgroundColor||"#020B22",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.translate(this.canvas.width/2+.5,this.canvas.height/2+.5),this.areaArray.forEach(function(t){t.drawMap()}),this.offContext.drawImage(this.canvas,0,0),this.renderCircle()}this.props.mapConfig&&this.props.mapConfig.map&&"district"===this.props.mapConfig.map.type&&(window.mapLoad=this.mapLoad.bind(this),"undefined"==typeof BMap?this.loadScript():this.mapLoad())}},{key:"render",value:function(){return _react2.default.createElement("div",{style:{position:"relative",width:"100%",height:"100%"}},_react2.default.createElement("canvas",{id:this.id},"对不起，您的浏览器不支持canvas"))}}]),i}();exports.default=ScatterCurveMap,ScatterCurveMap.propTypes={mapConfig:_propTypes2.default.shape({map:_propTypes2.default.object.isRequired}).isRequired};